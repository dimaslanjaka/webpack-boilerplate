<!-- Testimonials -->

<section class="bg-gray-100 mb-8">
  <div class="mx-auto px-6 py-20">
    <h2 class="text-4xl font-bold text-center text-gray-800 mb-8">Testimoni</h2>
    <div id="testiResult" class="flex overflow-x-auto"></div>
  </div>
</section>

<style>
  @-webkit-keyframes star-animation {
    0% {
      fill: #d0d8e0;
      stroke: #d0d8e0;
      stroke-width: 2;
      transform: scale(1) rotate(-72deg);
      opacity: 1;
    }
    50% {
      transform: scale(1.25);
    }
    65% {
      transform: scale(0.5);
    }
    80% {
      stroke: gold;
      transform: scale(1.1) rotate(-3deg);
    }
    100% {
      fill: gold;
      stroke: gold;
      transform: scale(1) rotate(0deg);
    }
  }
  @keyframes star-animation {
    0% {
      fill: #d0d8e0;
      stroke: #d0d8e0;
      stroke-width: 2;
      transform: scale(1) rotate(-72deg);
      opacity: 1;
    }
    50% {
      transform: scale(1.25);
    }
    65% {
      transform: scale(0.5);
    }
    80% {
      stroke: gold;
      transform: scale(1.1) rotate(-3deg);
    }
    100% {
      fill: gold;
      stroke: gold;
      transform: scale(1) rotate(0deg);
    }
  }
  @-webkit-keyframes circle-animation {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    30% {
      transform: scale(1.25);
      opacity: 0.3;
    }
    60% {
      transform: scale(1.75);
      opacity: 0.3;
    }
    100% {
      transform: scale(3);
      opacity: 0;
    }
  }
  @keyframes circle-animation {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    30% {
      transform: scale(1.25);
      opacity: 0.3;
    }
    60% {
      transform: scale(1.75);
      opacity: 0.3;
    }
    100% {
      transform: scale(3);
      opacity: 0;
    }
  }
  .review-stars {
    margin: 4px auto 16px;
    position: relative;
    display: flex;
    align-items: center;
    grid-gap: 0 calc(var(--size) / 2);
    justify-content: center;
    background: white;
    border-radius: 100px;
    padding: 16px 24px;
  }

  /*
  --------------------------------
  One Star SVG
*/
  svg.review-star {
    width: var(--size);
    height: var(--size);
    display: block;
    overflow: visible;
  }
  svg.review-star * {
    pointer-events: none;
  }
  svg.review-star path.star {
    stroke: transparent;
    stroke-width: 0;
  }
  svg.review-star path.star.on {
    fill: gold;
    opacity: 0;
  }
  svg.review-star path.star.off {
    fill: #d0d8e0;
  }
  svg.review-star circle {
    transform: scale(2);
    transform-origin: center;
    opacity: 0;
  }
  svg.review-star * {
    transform-origin: center;
  }

  /*
  --------------------------------
  Loading Skeleton State
*/
  .loading-skeleton .review-star {
    fill: #d0d8e0;
  }

  /*
  --------------------------------
  Animation On - SVG element
*/
  svg.review-star.animate-star .star.on {
    -webkit-animation: 0.6s star-animation ease-out;
    animation: 0.6s star-animation ease-out;
    -webkit-animation-delay: var(--delay, 0s);
    animation-delay: var(--delay, 0s);
    fill: gold;
    stroke: none;
    transform: rotate(0deg) scale(1);
    opacity: 1;
  }
  svg.review-star.animate-star .star.on + circle {
    stroke: none;
    fill: #ffe34d;
    -webkit-animation: circle-animation 0.6s cubic-bezier(0.47, 0, 0.745, 0.715) 0.25s;
    animation: circle-animation 0.6s cubic-bezier(0.47, 0, 0.745, 0.715) 0.25s;
  }

  /*
  --------------------------------
  Static, does not animate.
*/
  svg.review-star.filled .star.on {
    opacity: 1;
    transition: none;
  }
</style>

<script>
  class ReviewStars {
    /**
     * Create a group of SVG stars.
     * @param {Number} totalStars
     * @param {Number} averageRating
     * @param {Boolean} filled
     * @param {String} insertTo.position - "beforebegin" | "afterbegin" | "beforeend" | "afterend"
     * @param {HTMLElement} insertTo.element
     */
    constructor({
      totalStars = 5,
      averageRating = 3.5,
      filled = true,
      size = 16,
      stagger = 0.005,
      insertTo = {
        element: document.body,
        position: 'afterbegin'
      }
    } = {}) {
      this.stagger = stagger;
      this.filled = filled;
      this.totalStars = totalStars;
      this.averageRating = averageRating;
      this.size = size;
      this.el = this.createStars();
      this.append(insertTo);
    }

    /**
     *  Append the start to a DOM location.
     */
    append({ element, position }) {
      if (element && position) {
        element.insertAdjacentElement(position, this.el);
      } else {
        console.warn(`RatingStars did not append to the DOM. Check element or position.`);
      }
    }

    /**
     * Split the ratings at the decimal point.
     * Example: 4.25 returns ['4', '25']
     * @returns {number[]} - A two dimensional array.
     */
    get ratingsSplit() {
      const [integer, percent] = this.averageRating.toFixed(2).split('.');
      return [Number(integer || 0), Number(percent || 0)];
    }

    /**
     * Create stars.
     * @returns {string[]}
     */
    createStars() {
      const stars = document.createElement('div');
      const [nthChild, percent] = this.ratingsSplit;

      // Create an array of stars. HTML string template.
      for (let idx = 0; idx < this.totalStars; idx++) {
        // Crop the star with CSS clip-path.
        const cropStar = `clip-path: inset(0 ${100 - Number(percent)}% 0 0)`;

        // Identify the star to crop
        const isNthStar = nthChild === idx;

        // Apply crop style or empty string
        const styles = isNthStar ? cropStar : '';

        // Identify where the last rated star is located by index.
        const isAfterNth = !Boolean(nthChild < idx);

        stars.innerHTML += this.oneStarHTML(styles, idx, isAfterNth);
      }

      stars.classList.add('review-stars');
      stars.style.setProperty('--size', `${this.size}px`);

      return stars;
    }

    /**
     * SVG star icon.
     * @param {String} styles
     * @param {Boolean} isAfterNth - To toggle the start "on" or "off" based on the average rating.
     * @returns {String}
     */
    oneStarHTML(styles, idx, isAfterNth) {
      /**
       * Place 2 stars, stacked on each other, same path for both.
       * "on" - The stars are filled.
       * "off" - The stars are empty.
       */
      const starPath =
        'M8,0.4c0.3,0,0.5,0.2,0.7,0.4L10.7,5l4.6,0.7c0.3,0,0.5,0.2,0.6,0.5c0.1,0.3,0,0.6-0.2,0.7l-3.4,3.3l0.8,4.6 c0,0.3-0.1,0.5-0.3,0.7c-0.2,0.2-0.5,0.2-0.8,0.1L8,13.4l-4.2,2.2c-0.2,0.1-0.5,0.1-0.8-0.1c-0.2-0.2-0.3-0.4-0.3-0.7l0.8-4.6 L0.2,6.9C0,6.7,0,6.4,0,6.1c0.1-0.3,0.3-0.5,0.6-0.5L5.3,5l2.1-4.2C7.5,0.5,7.7,0.4,8,0.4z';
      return `
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="review-star ${this.filled ? 'filled' : ''}"
        data-review-star="${idx}"
        width="16"
        height="16"
        viewBox="0 0 16 16"
      >
        <path
          class="star off"
          d="${starPath}"
        />
        <path
          class="star ${isAfterNth ? 'on' : 'off'}"
          style="${styles}"
          d="${starPath}"
        />
        <circle
          cx="8"
          cy="8"
          r="7.5"
        />
      </svg>
    `;
    }

    /**
     * Animate the stars in.
     * @returns {Promise<Number>}
     */
    async animate() {
      if (this.filled) {
        return Promise.resolve(0);
      }

      let duration = 0;
      const stars = Array.from(this.el.children);

      return new Promise(resolve => {
        stars.forEach((star, idx) => {
          // Stagger the stars with a delay
          const delay = this.el.children.length * idx * this.stagger * 1000;
          setTimeout(() => star.classList.add('animate-star'), delay);

          // Let the last delay be the duration.
          duration = delay;
        });

        // When complete, resolve a callback.
        setTimeout(() => resolve(duration), duration);
      });
    }

    /**
     * Function for debugging.
     * @returns {Promise<Number>}
     */
    async restart() {
      Array.from(this.el.children).forEach((star, idx) => star.classList.remove('animate-star'));

      return new Promise(resolve => {
        setTimeout(() => {
          this.animate().then(d => resolve(d));
        }, 250);
      });
    }
  }

  // Populate testimonial data
  const testiResult = document.querySelector('#testiResult');
  fetch('/source/data/testimoni.json')
    .then(res => res.json())
    .then(datas => {
      for (let i = 0; i < datas.length; i++) {
        const data = datas[i];
        const html = `
    <div class="w-80 flex-shrink-0">
      <div class="w-full md:w-1/3 px-2 mb-4">
        <div class="bg-white rounded shadow py-2">
          <div class="star-rating"></div>
          <p class="text-gray-800 text-base px-6 mb-5">
            ${data.message}
          </p>
          <div class="flex justify-around">
            <div class="text-gray-500 text-xs md:text-sm px-6">${data.name}</div>
            <div class="text-gray-500 text-xs md:text-sm px-6">${data.date}</div>
          </div>
        </div>
      </div>
    </div>`;
        testiResult.innerHTML += html;
      }
    })
    .then(() => {
      // ReviewStars Usage
      const starsEl = Array.from(document.querySelectorAll('.star-rating'));
      for (let i = 0; i < starsEl.length; i++) {
        const element = starsEl[i];
        const stars = new ReviewStars({
          totalStars: 5,
          averageRating: 4.5,
          size: 24,
          filled: false,
          insertTo: {
            element,
            position: 'afterbegin'
          }
        });

        document.addEventListener('click', () => stars.restart());
        setTimeout(() => stars.restart(), 1000);
      }
    });
</script>
